# Watermark Remover (YOLOv11-Seg + LaMa)

Пайплайн для удаления водяных знаков. Использует обучение на синтетических данных (YOLOv11 Instance Segmentation) и inpainting (LaMa).

**Алгоритм:**
* (обучение)
1.  Размещение `watermark.png`.
2.  `0_download_backgrounds.py` (Фоны).
3.  `1_image_generator.py` (Синтетика).
4.  `2_train_model.py` (Обучение).
* (работа)
5.  Деплой модели (`best.pt` -> `models/`).
6.  `3_run_pipeline.py` (Обработка).

---

## Часть про обучение

### 1. Подготовка ресурсов

**Водяной знак:**
*   Файл: `watermark.png` (корень проекта).
*   Формат: PNG с прозрачностью (Alpha channel). 

Можно удалить с помощью встроенной в windows 11 в фото функции удаление фона с помощью AI.
Обязательно сохранять в PNG. 

**Фоны для обучения:**
*   Выполнить: `python 0_download_backgrounds.py`
*   Загружает датасет COCO Val 2017 (~1 ГБ) в папку `backgrounds/`.

---

### 2. Генерация датасета

Создание синтетической обучающей выборки с аугментациями (прозрачность, размытие, шум, аффинные преобразования). Параметры настраиваются в `config.py`.

*   Выполнить: `python 1_image_generator.py`
*   Результат: Структурированный датасет в `train_dataset/`.

---

### 3. Обучение (YOLO-Seg)

Дообучение модели сегментации на сгенерированных данных.

*   Выполнить: `python 2_train_model.py`
*   Результат: Веса модели в `runs/segment/train_seg_run/weights/best.pt`.

---

## Часть про работу

### 4. Деплой и Валидация

**Установка весов:**
Скопировать `best.pt` из папки результатов обучения в `models/` (с заменой).

**Входные данные:**
Поместить изображения для обработки в `images_input/`.

**Бенчмарки (Проверка качества):**
Перед полным запуском (и для файла 0_download_backgrounds перед обучением) рекомендуется проверить работу на выборке (первые 10 фото):
*   `benchmarks/0_check_dataset.py` — Проверка правильно ли расставились координаты классов для обучения. Генерирует изображения с наложенной маской в `bench_tests/`. Оценка точности охвата логотипа.
*   `benchmarks/1_bench_detector.py` — Проверка детекции. Генерирует изображения с наложенной красной маской в `bench_tests/`. Оценка точности захвата логотипа.
*   `benchmarks/2_bench_cleaner.py` — Проверка очистки. Генерирует коллаж "Оригинал | Маска | Результат". Оценка работы LaMa.
*   `benchmarks/3_bench_speed.py` — Замер скорости (FPS) и прогноз времени выполнения.

---

### 5. Запуск (Production)

Обработка всего массива изображений.

*   Выполнить: `python 3_run_pipeline.py`

**Логика:**
1.  Скан `images_input/`.
2.  Генерация маски (YOLO).
3.  Восстановление фона (LaMa).
4.  Сохранение в `images_cleaned/` (структура папок сохраняется).

*Поддерживается пропуск уже обработанных файлов. 
(проверка по имени файлов - после обработки у фото такое же название как и у исходного)*

---

## Работа с докером

1.  **Скачать:** Склонируй репозиторий (или распакуй архив).
2.  **Модель:** Положи файл `best.pt` в папку `models/`.
3.  **Изображения:** Закинь изображения, которые нужно обработать в папку `images_input/`.
4.  **Запуск (Сборка):**
    Открой терминал в папке и введи:
    ```bash
    docker-compose up -d --build
    ```
    *(Он подождет 10 минут, пока всё скачается и установится).*
5.  **Работа:**
    Когда контейнер запустился, выполняй скрипты:
    ```bash
    docker-compose exec watermark-remover python 3_run_pipeline.py
    ```

## Работа с api

1.  Создать **Очередь** из путей к файлам (все фото).
2.  Запустить **20 воркеров** (асинхронных задач). Каждый воркер делает бесконечный цикл:
    *   Берет файл из Очереди.
    *   Отправляет `POST /process` с файлом.
    *   **Ждет ответ.**
    *   Берет следующий файл.

### DOCS

**Base URL:** `http://<IP-ADDRESS>:8000`

### Endpoint: `POST /process`
Отправка изображения на обработку.

#### 1. Request
*   **Content-Type:** `multipart/form-data`
*   **Body Parameter:**
    * `Key`: *file*
    * `Value`: *Binary Image*

#### 2. Response
*   **Body:** `multipart/form-data`
*   **Header `Clean-Status`:**
    * `cleaned`: Найдено и удалено
    * `skipped`: Не найдено. Возврат оригинала

Чтобы понять, была ли удалена ватермарка, нужно смотреть заголовок (Header) **`Clean-Status`**.

| HTTP Код | Заголовок `Clean-Status` | Содержимое ответа | Значение |
| :--- | :--- | :--- | :--- |
| **200 OK** | `cleaned` | **Обработанное фото** | Найдено и удалено. |
| **200 OK** | `skipped` | **Оригинал фото** | Не найдено. Фото возвращено без изменений. |
| **400** | - | JSON с ошибкой | Битая картинка или неверный формат. |
| **500** | - | JSON с ошибкой | Сбой сервера (GPU/Memory). Рекомендуется повторить запрос (Retry). |