"""
–ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞.
–¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (Strategy Map).

–ó–¥–µ—Å—å —Ç—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—à—å, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –±—É–¥–µ—Ç "–ª–µ—á–∏—Ç—å" –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å.
"""

import torch
from pathlib import Path

# ==============================================================================
# üìÇ 1. –ü–£–¢–ò –ö –ü–ê–ü–ö–ê–ú –ò –§–ê–ô–õ–ê–ú
# ==============================================================================
BASE_DIR = Path(__file__).parent

INPUT_DIR = BASE_DIR / "images_input"       # –í—Ö–æ–¥–Ω—ã–µ —Ñ–æ—Ç–æ
OUTPUT_DIR = BASE_DIR / "images_cleaned"    # –†–µ–∑—É–ª—å—Ç–∞—Ç
LOG_DIR = BASE_DIR / "logs"                 # –õ–æ–≥–∏
MODELS_DIR = BASE_DIR / "models"            # –í–µ—Å–∞ –º–æ–¥–µ–ª–µ–π

# ==============================================================================
# üß† 2. –ù–ê–°–¢–†–û–ô–ö–ò –ú–û–î–ï–õ–ï–ô
# ==============================================================================

# --- YOLO (–î–µ—Ç–µ–∫—Ü–∏—è) ---
YOLO_MODEL_NAME = "yolo11n.pt"              # –ò–º—è –±–∞–∑–æ–≤–æ–π –º–æ–¥–µ–ª–∏ (—Å–∫–∞—á–∞–µ—Ç—Å—è —Å–∞–º–∞)
YOLO_MODEL_PATH = MODELS_DIR / "best.pt"    # –¢–≤–æ—è –æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
YOLO_CONFIDENCE = 0.30                      # –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏

# --- ‚ö° –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –†–ê–ú–û–ö (–ù–û–í–û–ï) ---
# –ï—Å–ª–∏ True, –æ—Å—Ç–∞–≤–∏—Ç —Ç–æ–ª—å–∫–æ 'max_instances' —Å–∞–º—ã—Ö —É–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–º–æ–∫.
LIMIT_BOXES = False

# --- SAM (–°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è) ---
SAM_MODEL_NAME = "sam2.1_b.pt"              # b=base (–±–∞–ª–∞–Ω—Å), l=large (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ)

# --- OCR (–¢–µ–∫—Å—Ç) ---
OCR_LANGS = ['en']                          # –Ø–∑—ã–∫–∏ (en, ru)

# --- LaMa (–£–¥–∞–ª–µ–Ω–∏–µ) ---
LAMA_MODEL_NAME = "big-lama"                # –ú–æ–¥–µ–ª—å –¥–ª—è –∑–∞–∫—Ä–∞—à–∏–≤–∞–Ω–∏—è

# ==============================================================================
# üéì –°–ü–†–ê–í–û–ß–ù–ò–ö –ü–û –ù–ê–°–¢–†–û–ô–ö–ï (–ß–ò–¢–ê–¢–¨ –ü–ï–†–ï–î –ò–ó–ú–ï–ù–ï–ù–ò–ï–ú)
# ==============================================================================
"""
1. STRATEGY (–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è):
   - 'BOX': –¢—É–ø–æ –∑–∞–∫—Ä–∞—à–∏–≤–∞–µ—Ç –≤–µ—Å—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—à–ª–∞ YOLO.
     >>> –ò–î–ï–ê–õ–¨–ù–û –î–õ–Ø: –¢–µ–∫—Å—Ç–∞ (Text). LaMa –ª—é–±–∏—Ç —Å–ø–ª–æ—à–Ω—ã–µ –±–ª–æ–∫–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–∏—â–µ.
     >>> –°–ö–û–†–û–°–¢–¨: –ú–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–æ.

   - 'SAM': –£–º–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–Ω—Ç—É—Ä—É –æ–±—ä–µ–∫—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏.
     >>> –ò–î–ï–ê–õ–¨–ù–û –î–õ–Ø: –õ–æ–≥–æ—Ç–∏–ø–æ–≤, –ª—é–¥–µ–π, –æ–±—ä–µ–∫—Ç–æ–≤ —Å–ª–æ–∂–Ω–æ–π —Ñ–æ—Ä–º—ã.
     >>> –°–ö–û–†–û–°–¢–¨: –ú–µ–¥–ª–µ–Ω–Ω–µ–µ (–Ω—É–∂–µ–Ω –ø—Ä–æ–≥–æ–Ω –Ω–µ–π—Ä–æ—Å–µ—Ç–∏).

   - 'OCR': –ò—â–µ—Ç –±—É–∫–≤—ã –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏.
     >>> –ò–î–ï–ê–õ–¨–ù–û –î–õ–Ø: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–∞–º–∫–∞ YOLO –æ–≥—Ä–æ–º–Ω–∞—è, –∞ —Ç–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ –º–µ–ª–∫–∏–π –∏ –ø–æ–≤–µ—Ä–Ω—É—Ç.
     >>> –°–û–í–ï–¢: –î–ª—è –≤–∞—Ç–µ—Ä–º–∞—Ä–æ–∫ –æ–±—ã—á–Ω–æ —Ö—É–∂–µ, —á–µ–º 'BOX', —Ç–∞–∫ –∫–∞–∫ –æ—Å—Ç–∞–≤–ª—è–µ—Ç "–≥—Ä—è–∑—å" –º–µ–∂–¥—É –±—É–∫–≤–∞–º–∏.

2. PADDING (–û—Ç—Å—Ç—É–ø –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π, px):
   - –†–∞—Å—à–∏—Ä—è–µ—Ç —Ä–∞–º–∫—É YOLO –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –æ—Ç–¥–∞—Ç—å –µ—ë –≤ SAM –∏–ª–∏ –∑–∞–∫—Ä–∞—Å–∏—Ç—å.
   - –î–ª—è 'BOX': –°—Ç–∞–≤—å 2-5px (—á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –∑–∞—Ü–µ–ø–∏—Ç—å –∫—Ä–∞—è –±—É–∫–≤).
   - –î–ª—è 'SAM': –°—Ç–∞–≤—å 10-20px (SAM –Ω—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å —Ñ–æ–Ω –≤–æ–∫—Ä—É–≥ –æ–±—ä–µ–∫—Ç–∞, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –≥–¥–µ –≥—Ä–∞–Ω–∏—Ü—ã).

3. DILATION (–ñ–∏—Ä–Ω–æ—Å—Ç—å –º–∞—Å–∫–∏, px):
   - "–†–∞–∑–¥—É–≤–∞–µ—Ç" –±–µ–ª—É—é –º–∞—Å–∫—É —É–∂–µ –ø–æ—Å–ª–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è. –£–±–∏—Ä–∞–µ—Ç "–æ—Ä–µ–æ–ª—ã" –∏ –∫–∞–µ–º–∫–∏.
   - –î–ª—è –¢–µ–∫—Å—Ç–∞: 0-2px.
   - –î–ª—è –õ–æ–≥–æ—Ç–∏–ø–æ–≤: 5-10px (–ª–æ–≥–æ—Ç–∏–ø—ã —á–∞—Å—Ç–æ –∏–º–µ—é—Ç –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫—Ä–∞—è, –∏—Ö –Ω–∞–¥–æ –Ω–∞–∫—Ä—ã—Ç—å —Å –∑–∞–ø–∞—Å–æ–º).
"""

# ==============================================================================
# üéÆ 3. –ö–ê–†–¢–ê –°–¢–†–ê–¢–ï–ì–ò–ô (CLASS MAPPING)
# –ö–ª—é—á–∏ —Å–ª–æ–≤–∞—Ä—è (0, 1, 2...) –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å ID –∫–ª–∞—Å—Å–æ–≤ –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ YOLO!
# ==============================================================================

CLASS_PARAMS = {
    # --- –ö–õ–ê–°–° 0: –¢–ï–ö–°–¢ ---
    0: {
        'name': 'text',         # –ü—Ä–æ—Å—Ç–æ –∏–º—è –¥–ª—è –ª–æ–≥–æ–≤ (—á—Ç–æ–±—ã —Ç—ã –ø–æ–Ω–∏–º–∞–ª, —á—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è)
        'strategy': 'OCR',      # –í—ã–±–∏—Ä–∞–µ–º BOX –∏–ª–∏ OCR
        'padding': 6,           # +6 –ø–∏–∫—Å–µ–ª–µ–π –≤–æ –≤—Å–µ —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç —Ä–∞–º–∫–∏ YOLO
        'dilation': 0,          # –ù–µ —É—Ç–æ–ª—â–∞–µ–º, –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∏ —Ç–∞–∫ —Å–ø–ª–æ—à–Ω–æ–π
        'max_instances': 1      # –°–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º—É–º —Ç–∞–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏—Å–∫–∞—Ç—å?
    },

    # --- –ö–õ–ê–°–° 1: –õ–û–ì–û–¢–ò–ü ---
    1: {
        'name': 'logo',         # –ò–º—è –¥–ª—è –ª–æ–≥–æ–≤
        'strategy': 'SAM',      # –í—ã–±–∏—Ä–∞–µ–º SAM: –ª–æ–≥–æ—Ç–∏–ø –º–æ–∂–µ—Ç –±—ã—Ç—å –∫—Ä—É–≥–ª—ã–º –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–º
        'padding': 5,          # –î–∞–µ–º SAM –ø–æ–±–æ–ª—å—à–µ —Ñ–æ–Ω–∞ (–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
        'dilation': 3,          # –°–∏–ª—å–Ω–æ —Ä–∞—Å—à–∏—Ä—è–µ–º –º–∞—Å–∫—É, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –∫—Ä–∞—è –≤—ã—Ä–µ–∑–∞
        'max_instances': 1      # –°–∫–æ–ª—å–∫–æ –º–∞–∫—Å–∏–º—É–º —Ç–∞–∫–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏—Å–∫–∞—Ç—å?
    },

    # --- –ö–õ–ê–°–° 2: (–ï—Å–ª–∏ —É —Ç–µ–±—è –ø–æ—è–≤–∏—Ç—Å—è —Ç—Ä–µ—Ç–∏–π –∫–ª–∞—Å—Å, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å –µ–≥–æ) ---
    # 2: {
    #     'name': 'symbol',
    #     'strategy': 'SAM',
    #     'padding': 10,
    #     'dilation': 5
    # }
}

# –ï—Å–ª–∏ YOLO –Ω–∞–π–¥–µ—Ç –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ (fallback / –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫)
DEFAULT_PARAMS = {
    'strategy': 'BOX',
    'padding': 10,
    'dilation': 5,
    'max_instances': 1
}

# ==============================================================================
# üîß 4. –¢–û–ù–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê (TUNING)
# ==============================================================================

# --- –¢–Æ–ù–ò–ù–ì SAM ---
# –í–∫–ª—é—á–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ (CLAHE) –ø–µ—Ä–µ–¥ SAM?
# –ü–æ–º–æ–≥–∞–µ—Ç, –µ—Å–ª–∏ –ª–æ–≥–æ—Ç–∏–ø —Å–ª–∏–≤–∞–µ—Ç—Å—è —Å —Ç–µ–º–Ω—ã–º —Ñ–æ–Ω–æ–º.
SAM_ENHANCE_CONTRAST = True
# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã CLAHE –¥–ª—è SAM:
# –°–∏–ª–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ (2.0 - –Ω–æ—Ä–º, 4.0 - –∂–µ—Å—Ç–∫–æ).
SAM_CLAHE_CLIP = 2.0
# –†–∞–∑–º–µ—Ä —Å–µ—Ç–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ (8 - –±–∞–ª–∞–Ω—Å, 4 - –º–µ–Ω—å—à–µ —à—É–º–∞, 16 - –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π).
SAM_CLAHE_GRID = 8

# --- –¢–Æ–ù–ò–ù–ì OCR ---
# –í–∫–ª—é—á–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –¥–ª—è OCR? (–ü–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ True)
OCR_ENHANCE_CONTRAST = True
# –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ (0.0 - 1.0).
# –ï—Å–ª–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –±—É–∫–≤—ã -> —Å—Ç–∞–≤—å 0.3. –ï—Å–ª–∏ –ª–æ–≤–∏—Ç —à—É–º -> 0.6.
OCR_TEXT_THRESHOLD = 0.3
# –ü–æ—Ä–æ–≥ "—Å–ª–∞–±—ã—Ö —Å–≤—è–∑–µ–π" (–ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–±—Ä–∞—Ç—å —Å–ª–æ–≤–æ —Ü–µ–ª–∏–∫–æ–º).
OCR_LOW_TEXT = 0.3
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–∞—Å–∫–∏ OCR (–≤ –ø–∏–∫—Å–µ–ª—è—Ö).
# OCR —á–∞—Å—Ç–æ –¥–∞–µ—Ç —Ä–∞–º–∫–∏ –≤–ø—Ä–∏—Ç—ã–∫ –∫ –±—É–∫–≤–∞–º, –ª—É—á—à–µ –¥–æ–±–∞–≤–∏—Ç—å "–∂–∏—Ä–∫–∞".
OCR_EXPAND_PIXELS = 5

# ==============================================================================
# ‚öôÔ∏è 5. –°–ò–°–¢–ï–ú–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
# ==============================================================================
DEVICE = "cuda" if torch.cuda.is_available() else "cpu"

def setup_directories():
    """–ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    for path in [INPUT_DIR, OUTPUT_DIR, LOG_DIR, MODELS_DIR]:
        path.mkdir(parents=True, exist_ok=True)

setup_directories()